<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1020" />
  <title>面積 / 體積 練習器（PWA）</title>
  <link rel="manifest" href="manifest.webmanifest">

  <style>
    :root{
      --bg:#071022;
      --text:#e6edf7;
      --muted:#9fb0c9;
      --ok:#27c07d;
      --bad:#ff5c7a;
      --warn:#ffd166;
      --shadow: 0 10px 40px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:radial-gradient(1200px 600px at 30% 20%, #0e2a57 0%, var(--bg) 55%);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif;
    }
    .wrap{ max-width:1180px; margin:26px auto 34px; padding:0 14px; }
    .title{
      text-align:center; font-weight:800; letter-spacing:.5px;
      margin:8px 0 18px; font-size:clamp(18px,2.2vw,26px);
      color:#eaf2ff; text-shadow:0 6px 24px rgba(0,0,0,.35);
    }
    .grid{ display:grid; grid-template-columns:360px 1fr; gap:18px; align-items:start; }
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }

    .card{
      background: linear-gradient(180deg, rgba(18,34,66,.9), rgba(10,20,42,.88));
      border:1px solid rgba(55,86,140,.35);
      box-shadow:var(--shadow);
      border-radius:var(--radius);
      overflow:hidden;
    }
    .card-inner{ padding:16px; }
    .panel-head{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px 10px;
      border-bottom:1px solid rgba(70,105,170,.22);
    }
    .panel-head .label{ display:flex; gap:10px; align-items:center; font-weight:800; color:#dfeaff; }
    .badge{
      font-size:12px; color:#cfe0ff;
      background: rgba(45,108,255,.15);
      border: 1px solid rgba(45,108,255,.25);
      padding: 4px 8px; border-radius:999px;
    }

    .btn{
      border:0; color:#eaf2ff;
      background: linear-gradient(180deg, rgba(45,108,255,.95), rgba(32,90,220,.95));
      border: 1px solid rgba(90,150,255,.35);
      padding:10px 14px; border-radius:14px;
      font-weight:800; cursor:pointer;
      transition: transform .05s ease, filter .15s ease;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{
      background: linear-gradient(180deg, rgba(42,53,80,.95), rgba(28,36,56,.95));
      border: 1px solid rgba(120,150,210,.18);
      color:#e6edf7;
    }
    .btn.ghost{
      background: rgba(12,22,44,.6);
      border: 1px solid rgba(120,150,210,.18);
      color:#d9e6ff;
    }
    .btn.big{ padding:12px 16px; border-radius:16px; font-size:15px; }

    .row{ display:flex; gap:10px; }
    .row > *{ flex:1; }

    .field{
      margin:12px 0;
      background: rgba(8,16,34,.35);
      border: 1px solid rgba(120,150,210,.16);
      border-radius: 14px;
      padding: 12px;
    }
    .field .t{
      font-size:12px; color:var(--muted);
      margin-bottom:8px;
      display:flex; justify-content:space-between; gap:10px;
    }
    input, select{
      width:100%;
      background: rgba(10,20,42,.55);
      border: 1px solid rgba(120,150,210,.18);
      border-radius:12px;
      padding:11px 12px;
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    input::placeholder{ color: rgba(160,185,220,.65); }
    input[type="checkbox"]{ width:auto; }

    .hint{
      color: rgba(160,185,220,.9);
      font-size: 12px;
      line-height: 1.5;
      margin-top: 10px;
      opacity:.95;
    }

    .status{ font-weight:900; font-size:18px; margin-bottom:2px; }
    .sub{ font-size:12px; color:var(--muted); }
    .countdown{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px;
      background: rgba(10,20,42,.45);
      border: 1px solid rgba(120,150,210,.18);
      color:#d7e6ff; font-weight:800; white-space:nowrap;
    }

    .question{
      margin-top:14px;
      border-radius:16px;
      padding:16px;
      background: rgba(5,12,26,.35);
      border: 1px solid rgba(120,150,210,.16);
      min-height:126px;
    }
    .progress{ font-size:12px; color:var(--muted); margin-bottom:10px; }

    /* ===== 題目圖示 + 題目文字（桌機：圖左字右） ===== */
    .qrow{
      display:flex;
      gap:16px;
      align-items:flex-start;
    }

    .qicon{
      width:100px;
      height:200px;
      flex: 0 0 300px;
      border-radius: 18px;
      background: rgba(45,108,255,.10);
      border: 1px solid rgba(90,150,255,.22);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
      overflow:hidden;
    }

    .qicon svg{ width:104px; height:104px; }

    .qicon svg *{
      stroke: rgba(230,237,247,.92);
      fill: rgba(230,237,247,.10);
      stroke-width: 2.4;
    }

    .qicon text{
      fill: #000;
      font-size: 10px;
      font-weight: 900;
      stroke: none;
    }

    .qtext{
      font-size: clamp(18px, 2.1vw, 28px);
      font-weight: 900;
      letter-spacing: .3px;
      margin: 6px 0 12px;
      line-height: 1.25;
    }

    .answerbar{ display:flex; gap:10px; align-items:center; }
    .answerbar input{
      flex: 1.2;
      height:44px;
      border-radius:14px;
      font-size:15px;
    }
    .answerbar .btn{ min-width:140px; height:44px; }

    /* ===== 手機：圖在上、文字在下 + 更大圖示 ===== */
    @media (max-width:720px){
      .qrow{
        flex-direction: column;
        align-items: center;
        text-align: center;
      }
      .qicon{
        width: 150px;
        height: 150px;
        flex: 0 0 auto;
        margin-bottom: 12px;
      }
      .qicon svg{
        width: 140px;
        height: 140px;
      }
      .qicon text{ font-size: 7.5px; }
      .qtext{ text-align:center; }

      .answerbar{
        flex-direction: column;
        align-items: stretch;
      }
      .answerbar .btn{ width:100%; }
    }

    .stats{ margin-top:10px; font-size:13px; color:#d7e6ff; }
    .stats .muted{ color:var(--muted); }

    .tableWrap{
      margin-top:12px;
      background: rgba(5,12,26,.28);
      border: 1px solid rgba(120,150,210,.14);
      border-radius: 16px;
      overflow:hidden;
    }
    table{ width:100%; border-collapse:collapse; font-size:13px; }
    thead{ background: rgba(10,20,42,.45); color:#ddebff; }
    th, td{
      padding:10px 10px;
      border-bottom: 1px solid rgba(120,150,210,.12);
      vertical-align: top;
    }
    tbody tr:hover{ background: rgba(45,108,255,.06); }
    .result-ok{ color: var(--ok); font-weight: 900; }
    .result-bad{ color: var(--bad); font-weight: 900; }
    .result-timeout{ color: var(--warn); font-weight: 900; }

    .footerBtns{ margin-top:12px; display:flex; gap:10px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="title">面積 / 體積 練習（網頁版 / 離線可用 / 可安裝）</div>

    <div class="grid">
      <!-- LEFT: SETTINGS -->
      <div class="card">
        <div class="panel-head">
          <div class="label">設定</div>
          <button class="btn ghost" id="btnClear">清空紀錄</button>
        </div>

        <div class="card-inner">
          <div class="field">
            <div class="t">
              <span>模式</span>
              <span class="badge" id="modeBadge">面積</span>
            </div>
            <select id="modeSel">
              <option value="area">面積（Area）</option>
              <option value="volume">體積（Volume）</option>
            </select>
          </div>

          <div class="row">
            <div class="field">
              <div class="t"><span>題數</span></div>
              <input id="totalInput" type="number" min="1" max="200" value="10" />
            </div>
            <div class="field">
              <div class="t"><span>每題限時(秒)</span></div>
              <input id="limitInput" type="number" min="1" max="999" value="5" />
            </div>
          </div>

          <div class="field">
            <div class="t" style="align-items:center">
              <span>不限時</span>
              <label style="display:flex;align-items:center;gap:10px; color:var(--muted); font-size:12px;">
                <input id="unlimitedChk" type="checkbox" />
                開
              </label>
            </div>
          </div>

          <div class="field">
            <div class="t"><span>出題難度（尺寸範圍）</span></div>
            <select id="difficultySel">
              <option value="easy">簡單（1~10）</option>
              <option value="mid" selected>一般（1~20）</option>
              <option value="hard">困難（1~50）</option>
            </select>
          </div>

          <div class="footerBtns">
            <button class="btn big" id="btnStart">開始</button>
            <button class="btn big secondary" id="btnStop">停止 / 結算</button>
          </div>

          <div class="field" style="margin-top:12px;">
            <button class="btn secondary" id="btnCSV" style="width:100%;">下載 CSV</button>
            <div class="hint">
              小提醒：資料會存在本機（localStorage）<br/>
              iOS：分享 → 加到主畫面；Android：瀏覽器選單 → 安裝應用程式
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT: MAIN -->
      <div class="card">
        <div class="panel-head">
          <div>
            <div class="status" id="statusText">尚未開始</div>
            <div class="sub" id="subText">按「開始」，後出題</div>
          </div>
          <div class="countdown">倒數：<span id="countdownText">-</span></div>
        </div>

        <div class="card-inner">
          <div class="question">
            <div class="progress" id="progressText">—</div>

            <div class="qrow">
              <div class="qicon" id="qIcon" aria-hidden="true"></div>
              <div class="qtext" id="questionText">—</div>
            </div>

            <div class="sub" style="margin: 10px 0 6px;">答案</div>
            <div class="answerbar">
              <input id="answerInput" inputmode="decimal" placeholder="輸入答案（可小數，如 12.5）" />
              <button class="btn" id="btnSubmit">提交</button>
            </div>

            <div class="stats" style="margin-top:12px;">
              <span class="muted">答對：</span><span id="sOK">0</span>
              <span class="muted">｜答錯：</span><span id="sBad">0</span>
              <span class="muted">｜超時：</span><span id="sTO">0</span>
              <span class="muted">｜正確率：</span><span id="sAcc">0.0%</span>
              <span class="muted">｜平均反應：</span><span id="sAvg">0.00s</span>
            </div>

            <div class="tableWrap">
              <table>
                <thead>
                  <tr>
                    <th style="width:44px;">#</th>
                    <th>題目</th>
                    <th style="width:120px;">你的答案</th>
                    <th style="width:140px;">正確答案</th>
                    <th style="width:80px;">結果</th>
                    <th style="width:90px;">反應(秒)</th>
                    <th style="width:160px;">時間</th>
                  </tr>
                </thead>
                <tbody id="tbody"></tbody>
              </table>
            </div>

          </div>
        </div>

      </div>
    </div>
  </div>

<script>
(() => {
  // ---------- helpers ----------
  const $ = (id) => document.getElementById(id);
  const nowStr = () => new Date().toLocaleString("zh-Hant", { hour12:false });
  const clamp = (v, a, b) => Math.min(b, Math.max(a, v));
  const randInt = (a,b) => Math.floor(Math.random()*(b-a+1))+a;
  const roundTo = (x, dp=2) => {
    const p = Math.pow(10, dp);
    return Math.round(x*p)/p;
  };
  const fmt2 = (x) => (Number.isFinite(x) ? x.toFixed(2) : "-");
  const safeNum = (s) => {
    if (typeof s !== "string") return NaN;
    const t = s.trim().replace(/，/g, ",");
    if (!t) return NaN;
    return Number(t);
  };
  const approxEqual = (a,b,eps=1e-9) => Math.abs(a-b) <= eps;

  // ---------- SVG icons with Chinese dimension labels ----------
  const ICONS = {
    rect: ({a,b}) => `
  <svg viewBox="0 0 64 64" role="img" aria-label="長方形">
    <rect x="14" y="18" width="36" height="28" rx="4"></rect>
    <path d="M14 50 H50" />
    <path d="M52 18 V46" />
    <text x="32" y="61" text-anchor="middle">長 ${a}</text>
    <text x="60" y="34" text-anchor="middle"
          transform="rotate(90 60 34)">寬 ${b}</text>
  </svg>`,
    tri: ({b,h}) => `
      <svg viewBox="0 0 64 64" role="img" aria-label="三角形">
        <path d="M14 46 L32 16 L50 46 Z"></path>
        <path d="M14 50 H50" />
        <path d="M32 16 V46" />
        <text x="32" y="61" text-anchor="middle">底 ${b}</text>
        <text x="36" y="34" text-anchor="start">高 ${h}</text>
      </svg>`,

    circle: ({r}) => `
      <svg viewBox="0 0 64 64" role="img" aria-label="圓">
        <circle cx="32" cy="32" r="18"></circle>
        <path d="M32 32 L50 32" />
        <text x="41" y="28" text-anchor="middle">半徑 ${r}</text>
      </svg>`,

    trap: ({a,b,h}) => `
      <svg viewBox="0 0 64 64" role="img" aria-label="梯形">
        <path d="M18 46 L24 18 L40 18 L46 46 Z"></path>
        <path d="M24 14 H40" />
        <path d="M18 50 H46" />
        <path d="M32 18 V46" />
        <text x="32" y="10" text-anchor="middle">上底 ${a}</text>
        <text x="32" y="61" text-anchor="middle">下底 ${b}</text>
        <text x="36" y="34" text-anchor="start">高 ${h}</text>
      </svg>`,

    cube: ({a}) => `
      <svg viewBox="0 0 64 64" role="img" aria-label="立方體">
        <path d="M18 26 L32 18 L46 26 L32 34 Z"></path>
        <path d="M18 26 L18 42 L32 50 L32 34 Z"></path>
        <path d="M46 26 L46 42 L32 50 Z"></path>
        <text x="32" y="61" text-anchor="middle">邊長 ${a}</text>
      </svg>`,

    rectprism: ({l,w,h}) => `
<svg viewBox="0 0 100 80" role="img" aria-label="長方體">
  <!-- 上面 -->
  <path d="M18 30 L34 18 L82 18 L66 30 Z"
        fill="rgba(255,255,255,0.08)" stroke="#ddd" stroke-width="3"></path>

  <!-- 正面 -->
  <rect x="18" y="30" width="48" height="36" rx="2"
        fill="rgba(255,255,255,0.06)" stroke="#ddd" stroke-width="3"></rect>

  <!-- 右側 -->
  <path d="M66 30 L82 18 L82 54 L66 66 Z"
        fill="rgba(255,255,255,0.05)" stroke="#ddd" stroke-width="3"></path>

  <!-- 寬（上方，往下移避免切） -->
  <text x="58" y="12" text-anchor="middle"
        fill="black" font-size="10" font-weight="bold">
    寬 ${w}
  </text>

  <!-- 長（底部） -->
  <text x="42" y="78" text-anchor="middle"
        fill="black" font-size="10" font-weight="bold">
    長 ${l}
  </text>

  <!-- 高（右側：用 end，避免切） -->
  <text x="98" y="48" text-anchor="end"
        fill="black" font-size="10" font-weight="bold">
    高 ${h}
  </text>
</svg>
`,

    cyl: ({r,h}) => `
<svg viewBox="0 0 100 80" role="img" aria-label="圓柱">
  <!-- 上橢圓 -->
  <ellipse cx="50" cy="20" rx="26" ry="10"
           fill="rgba(255,255,255,0.08)" stroke="#ddd" stroke-width="3"></ellipse>

  <!-- 側面 -->
  <path d="M24 20 V56 C24 62 36 68 50 68 C64 68 76 62 76 56 V20"
        fill="rgba(255,255,255,0.05)" stroke="#ddd" stroke-width="3"></path>

  <!-- 半徑線 -->
  <line x1="50" y1="20" x2="76" y2="20"
        stroke="#ccc" stroke-width="2"></line>

  <!-- 半徑字（上方：往下移、並靠左一點避免切） -->
  <text x="63" y="12" text-anchor="middle"
        fill="black" font-size="10" font-weight="bold">
    半徑 ${r}
  </text>

  <!-- 高的尺寸線 -->
  <line x1="86" y1="20" x2="86" y2="56"
        stroke="#ccc" stroke-width="2"></line>

  <!-- 高字（右側：用 end，避免切） -->
  <text x="98" y="40" text-anchor="end"
        fill="black" font-size="10" font-weight="bold">
    高 ${h}
  </text>
</svg>
`,

    cone: ({r,h}) => `
      <svg viewBox="0 0 64 64" role="img" aria-label="圓錐">
        <ellipse cx="32" cy="46" rx="18" ry="6"></ellipse>
        <path d="M14 46 L32 14 L50 46"></path>
        <path d="M32 14 V46" />
        <path d="M32 46 L50 46" />
        <text x="36" y="32" text-anchor="start">高 ${h}</text>
        <text x="42" y="42" text-anchor="middle">半徑 ${r}</text>
      </svg>`,

    sphere: ({r}) => `
      <svg viewBox="0 0 64 64" role="img" aria-label="球">
        <circle cx="32" cy="32" r="18"></circle>
        <ellipse cx="32" cy="32" rx="18" ry="7"></ellipse>
        <path d="M32 32 L50 32" />
        <text x="41" y="28" text-anchor="middle">半徑 ${r}</text>
      </svg>`
  };

  const setQIcon = (key, params={}) => {
    const el = $("qIcon");
    if (!el) return;
    const fn = ICONS[key];
    el.innerHTML = (typeof fn === "function") ? fn(params) : "";
  };

  // ---------- storage ----------
  const KEY = "area_volume_practice_records_v2";
  const loadRecords = () => {
    try { return JSON.parse(localStorage.getItem(KEY) || "[]"); }
    catch { return []; }
  };
  const saveRecords = (arr) => localStorage.setItem(KEY, JSON.stringify(arr));

  // ---------- state ----------
  let records = loadRecords();
  let running = false;
  let idx = 0;
  let total = 10;
  let question = null; // { text, answer, answerText, iconKey, iconParams }
  let qStartTs = 0;
  let timer = null;
  let remain = null;

  // ---------- stats ----------
  const computeStats = () => {
    let ok=0, bad=0, to=0, sumRt=0, cntRt=0;
    for (const r of records){
      if (r.result === "答對") ok++;
      else if (r.result === "答錯") bad++;
      else if (r.result === "超時") to++;
      if (typeof r.rt === "number" && Number.isFinite(r.rt)){
        sumRt += r.rt; cntRt++;
      }
    }
    const done = ok + bad + to;
    const acc = done ? (ok / done) * 100 : 0;
    const avg = cntRt ? (sumRt / cntRt) : 0;
    return { ok, bad, to, acc, avg };
  };

  const renderStats = () => {
    const s = computeStats();
    $("sOK").textContent = s.ok;
    $("sBad").textContent = s.bad;
    $("sTO").textContent = s.to;
    $("sAcc").textContent = s.acc.toFixed(1) + "%";
    $("sAvg").textContent = fmt2(s.avg) + "s";
  };

  const renderTable = () => {
    const tb = $("tbody");
    tb.innerHTML = "";
    records.slice().reverse().forEach((r, iRev) => {
      const i = records.length - iRev;
      const tr = document.createElement("tr");

      const td1 = document.createElement("td"); td1.textContent = i; tr.appendChild(td1);
      const td2 = document.createElement("td"); td2.textContent = r.q; tr.appendChild(td2);
      const td3 = document.createElement("td"); td3.textContent = r.your; tr.appendChild(td3);
      const td4 = document.createElement("td"); td4.textContent = r.ans; tr.appendChild(td4);

      const td5 = document.createElement("td");
      td5.textContent = r.result;
      td5.className =
        r.result === "答對" ? "result-ok" :
        r.result === "答錯" ? "result-bad" :
        "result-timeout";
      tr.appendChild(td5);

      const td6 = document.createElement("td");
      td6.textContent = (typeof r.rt === "number" && Number.isFinite(r.rt)) ? fmt2(r.rt) : "-";
      tr.appendChild(td6);

      const td7 = document.createElement("td"); td7.textContent = r.time; tr.appendChild(td7);

      tb.appendChild(tr);
    });
  };

  // ---------- UI sync ----------
  const syncUIFromMode = () => {
    const mode = $("modeSel").value;
    $("modeBadge").textContent = (mode === "area") ? "面積" : "體積";
    $("answerInput").placeholder = "輸入答案（可小數，如 12.5）";
  };

  const sizeRange = () => {
    const d = $("difficultySel").value;
    if (d === "easy") return [1, 10];
    if (d === "hard") return [1, 50];
    return [1, 20];
  };

  // ---------- question generators ----------
  function genAreaQ(){
    const [lo, hi] = sizeRange();
    const shapes = ["rect","tri","circle","trap"];
    const pick = shapes[randInt(0, shapes.length-1)];

    if (pick === "rect"){
      const a = randInt(lo, hi);
      const b = randInt(lo, hi);
      const ans = a * b;
      return {
        iconKey: "rect",
        iconParams: { a, b },
        text: `長方形：長 ${a}、寬 ${b}，求面積（平方單位）`,
        answer: ans,
        answerText: `${ans}`,
      };
    }

    if (pick === "tri"){
      const b = randInt(lo, hi);
      const h = randInt(lo, hi);
      const ans = 0.5 * b * h;
      const a2 = roundTo(ans, 2);
      return {
        iconKey: "tri",
        iconParams: { b, h },
        text: `三角形：底 ${b}、高 ${h}，求面積（平方單位）`,
        answer: a2,
        answerText: `${a2}`,
      };
    }

    if (pick === "circle"){
      const r = randInt(lo, hi);
      const ans = Math.PI * r * r;
      const a2 = roundTo(ans, 2);
      return {
        iconKey: "circle",
        iconParams: { r },
        text: `圓：半徑 ${r}，求面積（取 π=3.14159，答案到小數第2位）`,
        answer: a2,
        answerText: `${a2}`,
      };
    }

    // trapezoid
    const a = randInt(lo, hi);
    const b = randInt(lo, hi);
    const h = randInt(lo, hi);
    const ans = 0.5 * (a + b) * h;
    const a2 = roundTo(ans, 2);
    return {
      iconKey: "trap",
      iconParams: { a, b, h },
      text: `梯形：上底 ${a}、下底 ${b}、高 ${h}，求面積（平方單位）`,
      answer: a2,
      answerText: `${a2}`,
    };
  }

  function genVolumeQ(){
    const [lo, hi] = sizeRange();
    const shapes = ["cube","rectprism","cyl","cone","sphere"];
    const pick = shapes[randInt(0, shapes.length-1)];

    if (pick === "cube"){
      const a = randInt(lo, hi);
      const ans = a*a*a;
      return {
        iconKey: "cube",
        iconParams: { a },
        text: `立方體：邊長 ${a}，求體積（立方單位）`,
        answer: ans,
        answerText: `${ans}`,
      };
    }

    if (pick === "rectprism"){
      const l = randInt(lo, hi);
      const w = randInt(lo, hi);
      const h = randInt(lo, hi);
      const ans = l*w*h;
      return {
        iconKey: "rectprism",
        iconParams: { l, w, h },
        text: `長方體：長 ${l}、寬 ${w}、高 ${h}，求體積（立方單位）`,
        answer: ans,
        answerText: `${ans}`,
      };
    }

    if (pick === "cyl"){
      const r = randInt(lo, hi);
      const h = randInt(lo, hi);
      const ans = Math.PI * r * r * h;
      const a2 = roundTo(ans, 2);
      return {
        iconKey: "cyl",
        iconParams: { r, h },
        text: `圓柱：半徑 ${r}、高 ${h}，求體積（取 π=3.14159，答案到小數第2位）`,
        answer: a2,
        answerText: `${a2}`,
      };
    }

    if (pick === "cone"){
      const r = randInt(lo, hi);
      const h = randInt(lo, hi);
      const ans = (1/3) * Math.PI * r * r * h;
      const a2 = roundTo(ans, 2);
      return {
        iconKey: "cone",
        iconParams: { r, h },
        text: `圓錐：半徑 ${r}、高 ${h}，求體積（取 π=3.14159，答案到小數第2位）`,
        answer: a2,
        answerText: `${a2}`,
      };
    }

    // sphere
    const r = randInt(lo, hi);
    const ans = (4/3) * Math.PI * r * r * r;
    const a2 = roundTo(ans, 2);
    return {
      iconKey: "sphere",
      iconParams: { r },
      text: `球：半徑 ${r}，求體積（取 π=3.14159，答案到小數第2位）`,
      answer: a2,
      answerText: `${a2}`,
    };
  }

  // ---------- flow ----------
  function stopCountdown(){
    if (timer){ clearInterval(timer); timer = null; }
  }

  function startCountdownIfNeeded(){
    stopCountdown();
    const unlimited = $("unlimitedChk").checked;
    if (unlimited){
      remain = null;
      $("countdownText").textContent = "-";
      return;
    }
    const lim = clamp(parseInt($("limitInput").value || "5", 10), 1, 999);
    remain = lim;
    $("countdownText").textContent = String(remain);

    timer = setInterval(() => {
      remain -= 1;
      if (remain <= 0){
        $("countdownText").textContent = "0";
        onTimeout();
      } else {
        $("countdownText").textContent = String(remain);
      }
    }, 1000);
  }

  function finishSession(){
    running = false;
    stopCountdown();
    $("statusText").textContent = "已結束";
    $("subText").textContent = "可按「開始」再來一輪";
    $("countdownText").textContent = "-";
    idx = 0;
    question = null;
    $("progressText").textContent = "—";
    $("questionText").textContent = "—";
    setQIcon("", {});
  }

  function addRecord({q, your, ans, result, rt}){
    records.push({ q, your, ans, result, rt, time: nowStr() });
    saveRecords(records);
    renderTable();
    renderStats();
  }

  function nextQuestion(){
    const mode = $("modeSel").value;
    question = (mode === "area") ? genAreaQ() : genVolumeQ();

    $("questionText").textContent = question.text;
    setQIcon(question.iconKey, question.iconParams);

    $("answerInput").value = "";
    $("answerInput").focus();

    idx++;
    $("progressText").textContent = `第 ${idx} / ${total} 題`;
    qStartTs = performance.now();

    startCountdownIfNeeded();
  }

  function onTimeout(){
    if (!running || !question) return;
    stopCountdown();
    const rt = (performance.now() - qStartTs) / 1000;

    addRecord({
      q: question.text,
      your: "",
      ans: question.answerText,
      result: "超時",
      rt: roundTo(rt, 2),
    });

    if (idx >= total) finishSession();
    else nextQuestion();
  }

  function onSubmit(){
    if (!running || !question) return;
    stopCountdown();
    const rt = (performance.now() - qStartTs) / 1000;

    const raw = $("answerInput").value;
    const v = safeNum(raw);

    let result = "答錯";
    if (Number.isFinite(v)){
      const isIntAns = Number.isInteger(question.answer);
      if (isIntAns){
        result = (v === question.answer) ? "答對" : "答錯";
      } else {
        result = approxEqual(roundTo(v,2), question.answer, 1e-9) ? "答對" : "答錯";
      }
    }

    addRecord({
      q: question.text,
      your: raw.trim(),
      ans: question.answerText,
      result,
      rt: roundTo(rt, 2),
    });

    if (idx >= total) finishSession();
    else nextQuestion();
  }

  // ---------- buttons / events ----------
  $("btnStart").addEventListener("click", () => {
    total = clamp(parseInt($("totalInput").value || "10", 10), 1, 200);
    $("totalInput").value = total;

    running = true;
    idx = 0;
    $("statusText").textContent = "進行中";
    $("subText").textContent = "按「提交」作答；可用 Enter 送出";
    nextQuestion();
  });

  $("btnStop").addEventListener("click", () => {
    if (!running) return;
    finishSession();
  });

  $("btnSubmit").addEventListener("click", onSubmit);

  $("answerInput").addEventListener("keydown", (e) => {
    if (e.key === "Enter") onSubmit();
  });

  $("btnClear").addEventListener("click", () => {
    records = [];
    saveRecords(records);
    renderTable();
    renderStats();
  });

  $("btnCSV").addEventListener("click", () => {
    const header = ["#", "題目", "你的答案", "正確答案", "結果", "反應(秒)", "時間"];
    const rows = records.map((r, i) => [
      String(i+1),
      r.q,
      r.your ?? "",
      r.ans ?? "",
      r.result ?? "",
      (typeof r.rt === "number" && Number.isFinite(r.rt)) ? r.rt.toFixed(2) : "",
      r.time ?? ""
    ]);

    const esc = (s) => {
      const t = String(s ?? "");
      if (/[",\n]/.test(t)) return `"${t.replaceAll('"','""')}"`;
      return t;
    };

    const csv = [header, ...rows].map(line => line.map(esc).join(",")).join("\n");
    const blob = new Blob(["\ufeff" + csv], { type:"text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "area_volume_records.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  $("modeSel").addEventListener("change", () => {
    syncUIFromMode();
  });

  $("unlimitedChk").addEventListener("change", () => {
    if (!running || !question) return;
    startCountdownIfNeeded();
  });

  $("limitInput").addEventListener("change", () => {
    if (!running || !question) return;
    startCountdownIfNeeded();
  });

  // ---------- init ----------
  syncUIFromMode();
  renderTable();
  renderStats();

  // ---------- PWA: register service worker ----------
  if ("serviceWorker" in navigator){
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(() => {});
    });
  }
})();
</script>
</body>
</html>
